<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>系统管理 · 角色管理</title>
  <link rel="icon" href="../assets/logo-hrecs-radar.svg" type="image/svg+xml">
  <script src="../components/app-layout.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --blue-6: #2F54EB; /* 现代简约蓝 */
      --blue-5: #3B6AE8;
      --blue-4: #5C85F5;
      --text-strong: #1f2937;
      --text-muted: rgba(0,0,0,.45);
      --bg-body: #f6f8fc;
      --bg-card: #ffffff;
      --border: #e5e7eb;
      --radius-lg: 16px;
      --radius-md: 12px;
      --shadow: 0 10px 30px rgba(37,99,235,.12);
    }
    html, body { height:100%; }
    body { margin:0; background: var(--bg-body); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'PingFang SC', 'Microsoft YaHei', sans-serif; }

    /* 布局骨架 */
    .app { min-height: 100vh; display:grid; grid-template-columns: 240px 1fr; }
    .sider { background: var(--bg-card); border-right: 1px solid var(--border); padding: 18px 16px; }
    .sider-header { display:flex; align-items:center; gap:10px; padding: 8px 10px; border-radius: var(--radius-md); }
    .logo { width:32px; height:32px; border-radius:50%; background: linear-gradient(135deg, var(--blue-6), var(--blue-4)); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; }
    .title { font-weight:600; color: var(--text-strong); }

    .menu { margin-top: 16px; }
    .menu-group { margin: 10px 0; }
    .menu-title { display:none; }
    .menu-list { list-style:none; margin:0; padding:0; }
    .menu-item { display:flex; align-items:center; gap:10px; padding: 10px 12px; border-radius: 10px; cursor:pointer; color:#374151; }
    .menu-item:hover { background:#f0f5ff; }
    .menu-item.active { background:#e6f0ff; color: var(--blue-6); }
    .menu-item .icon { width:20px; height:20px; display:inline-flex; align-items:center; justify-content:center; color: var(--blue-6); }
    .submenu { margin-left: 10px; border-left: 2px dashed #eef2ff; padding-left: 8px; }

    /* 列表重置：去除 ul/li 默认样式 */
    .sys-menu, .sys-menu ul { list-style: none; margin: 0; padding: 0; }
    .sys-menu li { list-style: none; margin: 0; padding: 0; }
    .sys-menu-root { padding: 8px 0; }
    .sys-menu-item, .sys-menu-submenu-title { display:flex; align-items:center; justify-content:space-between; height:40px; line-height:40px; padding:0 16px; margin:0; border-radius:6px; cursor:pointer; color: rgba(0,0,0,.85); transition: all .2s ease; }
    .sys-menu-item .left, .sys-menu-submenu-title .left { display:flex; align-items:center; gap:10px; }
    .sys-menu-item.is-active { background:#e6f7ff; color: var(--blue-6); }
    .sys-menu-item.is-active .icon { color: var(--blue-6); }
    .sys-menu-submenu > .sys-menu { padding-left:24px; }
    .icon { font-size: 14px; width: 16px; display:inline-flex; align-items:center; justify-content:center; }

    /* 将主内容区域高度设置为 100vh，内容区为 100vh - 头部 64px */
    .main { height: 100vh; display:grid; grid-template-rows: 64px 1fr; }
    .header { background: var(--bg-card); border-bottom: 1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding: 0 16px; }
    .header-left { display:flex; align-items:center; gap:12px; color: var(--text-strong); }
    .header-right { display:flex; align-items:center; gap:16px; }
    /* 面包屑：展示菜单层级 */
    .breadcrumb { display:flex; align-items:center; gap:8px; font-size:14px; }
    .breadcrumb .crumb { color: rgba(0,0,0,.65); }
    .breadcrumb .crumb.current { color: var(--text-strong); font-weight:600; }
    .breadcrumb .sep { color: #d9d9d9; }
    .breadcrumb a { color: rgba(0,0,0,.85); text-decoration:none; }
    .breadcrumb a:hover { color: var(--blue-6); }
    .bell { width:28px; height:28px; border-radius: 50%; background:#f0f5ff; display:flex; align-items:center; justify-content:center; color: var(--blue-6); cursor:pointer; }
    .avatar-wrap { position:relative; }
    .avatar { width:32px; height:32px; border-radius:50%; background:#c1d4ff; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; cursor:pointer; }
    .user-menu { position:absolute; right:0; top:38px; background:#fff; border:1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow); list-style:none; padding:6px 0; margin:0; display:none; min-width:140px; z-index:20; }
    .avatar-wrap:hover .user-menu { display:block; }
    .user-menu li { padding:8px 12px; font-size:14px; color:#374151; cursor:pointer; }
    .user-menu li:hover { background:#f5f7fa; }

    /* 主内容区域填满高度，卡片内采用纵向布局 */
    .content { padding: 0; height: 100%; box-sizing:border-box; }
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--shadow); height: 100%; display:flex; flex-direction: column; }

    /* 角色管理：工具栏、表格、分页 */
    .toolbar { display:flex; align-items:center; justify-content:space-between; padding: 16px; border-bottom:1px solid var(--border); }
    .toolbar .left { display:flex; align-items:center; gap:12px; }
    .toolbar .left > div { display:flex; align-items:center; gap:8px; }
    .toolbar .right { display:flex; align-items:center; gap:10px; }
    
    /* 输入与选择：模仿 Ant Design 中等尺寸 */
    .input, .select {
      height: 32px;
      line-height: 32px;
      border-radius: 6px;
      padding: 4px 11px;
      border: 1px solid #d9d9d9;
      background: #fff;
      color: #333;
      font-size: 14px;
      box-sizing: border-box;
      outline: none;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .input:focus, .select:focus {
      border-color: var(--blue-6);
      box-shadow: 0 0 0 2px rgba(47, 84, 235, 0.2);
    }
    
    /* 按钮：模仿 Ant Design 中等尺寸 */
    .btn {
      height: 32px;
      padding: 0 15px;
      border-radius: 6px;
      border: 1px solid #d9d9d9;
      background: #fff;
      color: #444;
      cursor: pointer;
      transition: background-color .2s ease, border-color .2s ease, color .2s ease;
    }
    .btn:hover { background: #f5f5f5; }
    .btn:active { background: #f0f0f0; }
    .btn-primary {
      background: var(--blue-6);
      border-color: var(--blue-6);
      color: #fff;
    }
    .btn-primary:hover { background: var(--blue-5); border-color: var(--blue-5); }
    .op-btns .btn { height: 32px; padding: 0 12px; font-size: 12px; }

    /* 表格样式 */
    .table-wrap { flex: 1; overflow: auto; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    thead th { background: #fafafa; font-weight: 500; font-size: 14px; color: rgba(0,0,0,.88); padding: 12px 16px; border-bottom: 1px solid #f0f0f0; text-align: left; }
    tbody td { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; color: rgba(0,0,0,.88); }
    tbody tr:hover td { background: #fafafa; }
    .op-btns { display:flex; align-items:center; gap:8px; }

    /* 弹窗 */
    .modal-overlay { position: fixed; inset:0; background: rgba(0, 0, 0, 0.45); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-overlay.show { display: flex; }
    .modal { background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); width: 560px; max-width: 90vw; overflow: hidden; }
    .modal-header { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; display:flex; align-items:center; justify-content:space-between; }
    .modal-close { width:28px; height:28px; border-radius:50%; border:0; background:transparent; color:#666; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .modal-close:hover { background:#f5f5f5; }
    .modal-close:active { background:#eee; }
    .modal-body { padding: 16px; }
    .form-group { margin-bottom: 12px; }
    .form-label { display:block; margin-bottom:6px; color:#666; }
    .form-input, .form-select, .form-textarea { width:100%; border:1px solid #d9d9d9; border-radius:8px; padding:8px; box-sizing:border-box; }
    .form-textarea { height: 80px; }
    .modal-footer { display:flex; justify-content:flex-end; gap:8px; padding: 8px 16px; border-top:1px solid #f0f0f0; }
    .tag { display:inline-block; padding:2px 8px; border:1px solid #d9d9d9; border-radius:999px; font-size:12px; color:#555; margin-right:6px; }

    /* 权限树样式 */
    .perm-tree { border:1px solid #d9d9d9; border-radius:8px; padding:8px; max-height:220px; overflow:auto; background:#fafafa; }
    .perm-item { margin:4px 0; }
    .perm-node { display:flex; align-items:center; gap:6px; padding:2px 0; }
    .perm-label { color:#444; }
    .perm-children { margin-left:18px; border-left:1px dashed #eee; padding-left:8px; }
  /* 通用：删除按钮红色主题（按 title 匹配） */
  button[title="删除"] { background:#ff4d4f; border-color:#ff4d4f; color:#fff; }
  button[title="删除"]:hover { background:#f5222d; border-color:#f5222d; }
</style>
</head>
<body>
  <app-layout active="roles" breadcrumb="系统管理 / 角色管理">
    <section slot="content" class="content">
      <div class="card">
        <div class="toolbar">
          <div class="left">
            <div>
              <label>角色名称：</label>
              <input type="text" class="input" placeholder="请输入角色名称" id="searchRoleName" style="width: 200px;">
            </div>
            <div>
              <label>所属部门：</label>
              <select class="select" id="searchDepartment" style="width: 200px;">
                <option value="">全部</option>
              </select>
            </div>
            <button class="btn" onclick="searchRoles()"><i class="fa-solid fa-search"></i> 搜索</button>
            <button class="btn" onclick="resetSearch()"><i class="fa-solid fa-refresh"></i> 重置</button>
          </div>
          <div class="right">
            <button class="btn btn-primary" onclick="showAddModal()"><i class="fa-solid fa-plus"></i> 新增角色</button>
            <button class="btn" title="删除" onclick="deleteSelectedRoles()"><i class="fa-solid fa-trash"></i> 删除</button>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th class="check-col"><input type="checkbox" id="selectAllRoles" /></th>
                <th>角色名称</th>
                <th>所属部门</th>
                <th>备注</th>
                <th>创建时间</th>
                <th style="width:160px;">操作</th>
              </tr>
            </thead>
            <tbody id="roleTableBody"></tbody>
          </table>
        </div>
        <div class="pagination" style="padding: 12px 16px; border-top: 1px solid var(--border); display:flex; gap:8px;justify-content: center;">
          <button class="btn">上一页</button>
          <button class="btn btn-primary">1</button>
          <button class="btn">2</button>
          <button class="btn">3</button>
          <button class="btn">下一页</button>
        </div>
      </div>
    </section>

    <!-- 新增/编辑角色弹窗 -->
    <div slot="content" class="modal-overlay" id="roleModal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title" id="modalTitle">新增角色</div>
          <button class="modal-close" aria-label="关闭" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
          <form id="roleForm">
            <div class="form-group">
              <label class="form-label">角色名称 <span style="color:#ff4d4f;">*</span></label>
              <input class="form-input" id="roleName" placeholder="请输入角色名称" />
            </div>

            <div class="form-group">
              <label class="form-label">所属部门 <span style="color:#ff4d4f;">*</span></label>
              <select class="form-select" id="roleDepartments" multiple></select>
              <div id="selectedDeptTags" style="margin-top:6px;"></div>
            </div>

            <div class="form-group">
              <label class="form-label">备注</label>
              <textarea class="form-textarea" id="roleDesc" placeholder="请输入备注"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">权限</label>
              <div id="permissionTreeContainer" class="perm-tree"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal()">取消</button>
          <button class="btn btn-primary" onclick="saveRole()">保存</button>
        </div>
      </div>
    </div>
  </app-layout>

  <!-- 自定义确认弹窗 -->
  <div id="confirmOverlay" class="modal-overlay" aria-modal="true" role="dialog">
    <div class="modal" role="document">
      <div class="modal-header"><div>确认删除</div></div>
      <div class="modal-body"><div id="confirmMessage">确定要执行删除操作吗？删除后不可恢复！</div></div>
      <div class="modal-footer">
        <button class="btn" id="confirmCancelBtn">取消</button>
        <button class="btn btn-primary" id="confirmOkBtn">确定</button>
      </div>
    </div>
  </div>

  <!-- 角色弹窗已迁移到 app-layout 的 content 插槽中 -->

  <script>
    // 模拟部门数据（与部门管理结构一致，供角色关联使用）
    const departmentData = [
      { id: 1, name: '高速公路管理局', children: [
        { id: 2, name: '监控指挥中心', children: [
          { id: 5, name: '视频监控组' },
          { id: 6, name: '数据分析组' }
        ]},
        { id: 3, name: '应急救援中心' },
        { id: 4, name: '路政管理处' },
        { id: 7, name: '养护工程处' },
        { id: 8, name: '收费管理处' }
      ]}
    ];

    // 权限树数据：按需求调整为「用户 / 告警 / 应急指挥」三类
    // 用户：新增/编辑/查看/删除；告警：编辑；应急指挥：编辑
    const permissionTreeData = [
      { key: 'user', name: '用户', children: [
        { key: 'user:add', name: '新增' },
        { key: 'user:edit', name: '编辑' },
        { key: 'user:view', name: '查看' },
        { key: 'user:delete', name: '删除' }
      ]},
      { key: 'alert', name: '告警', children: [
        { key: 'alert:edit', name: '编辑' }
      ]},
      { key: 'emergency', name: '应急指挥', children: [
        { key: 'emergency:edit', name: '编辑' }
      ]}
    ];

    // 记录每个权限点的checkbox，便于父子联动与状态计算
    const permCheckboxByKey = new Map();

    function renderPermissionTree() {
      const container = document.getElementById('permissionTreeContainer');
      if (!container) return;
      container.innerHTML = '';
      permCheckboxByKey.clear();

      permissionTreeData.forEach(node => {
        container.appendChild(buildPermItem(node, null));
      });
    }

    function buildPermItem(node, parentKey) {
      const wrap = document.createElement('div');
      wrap.className = 'perm-item';
      wrap.dataset.key = node.key || node.name;

      const nodeDiv = document.createElement('div');
      nodeDiv.className = 'perm-node';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.dataset.key = node.key || node.name;
      if (parentKey) checkbox.dataset.parentKey = parentKey;
      permCheckboxByKey.set(checkbox.dataset.key, checkbox);

      const label = document.createElement('span');
      label.className = 'perm-label';
      label.textContent = node.name;

      nodeDiv.appendChild(checkbox);
      nodeDiv.appendChild(label);
      wrap.appendChild(nodeDiv);

      if (node.children && node.children.length) {
        const childrenDiv = document.createElement('div');
        childrenDiv.className = 'perm-children';
        node.children.forEach(child => {
          childrenDiv.appendChild(buildPermItem(child, node.key || node.name));
        });
        wrap.appendChild(childrenDiv);
      }

      checkbox.addEventListener('change', () => {
        propagateToChildren(checkbox.dataset.key, checkbox.checked);
        updateAncestorsState(checkbox.dataset.key);
      });

      return wrap;
    }

    function propagateToChildren(parentKey, checked) {
      permCheckboxByKey.forEach((cb) => {
        if (cb.dataset.parentKey === parentKey) {
          cb.checked = checked;
          cb.indeterminate = false;
          propagateToChildren(cb.dataset.key, checked);
        }
      });
    }

    function updateAncestorsState(key) {
      const cb = permCheckboxByKey.get(key);
      const parentKey = cb && cb.dataset.parentKey;
      if (!parentKey) return;

      const parentCb = permCheckboxByKey.get(parentKey);
      const children = [];
      permCheckboxByKey.forEach((c) => {
        if (c.dataset.parentKey === parentKey) children.push(c);
      });
      const total = children.length;
      const checkedCount = children.filter(c => c.checked).length;

      parentCb.checked = (checkedCount === total && total > 0);
      parentCb.indeterminate = (checkedCount > 0 && checkedCount < total);

      updateAncestorsState(parentKey);
    }

    function clearPermissionSelection() {
      permCheckboxByKey.forEach(cb => {
        cb.checked = false;
        cb.indeterminate = false;
      });
    }

    function setSelectedPermissions(keys = []) {
      clearPermissionSelection();
      keys.forEach(k => {
        const cb = permCheckboxByKey.get(k);
        if (cb) {
          cb.checked = true;
          updateAncestorsState(k);
        }
      });
    }

    function getSelectedPermissions() {
      const selected = [];
      permCheckboxByKey.forEach((cb, key) => {
        if (cb.checked) selected.push(key);
      });
      return selected.filter(k => k.includes(':'));
    }

    // 扁平化部门列表
    function flattenDepartments(nodes, acc = []) {
      nodes.forEach(n => {
        acc.push({ id: n.id, name: n.name });
        if (n.children) flattenDepartments(n.children, acc);
      });
      return acc;
    }

    // 模拟角色数据
    let roleData = [
      { id: 1, name: '系统管理员', departments: [1], remark: '拥有系统全部权限', createTime: '2023-01-20 10:00:00', permissions: ['user:add','user:edit','user:view','user:delete','alert:edit','emergency:edit'] },
      { id: 2, name: '部门主管', departments: [2,3], remark: '管理部门相关权限', createTime: '2023-02-18 15:30:00', permissions: ['user:view'] }
    ];

    let currentEditRoleId = null;
    const selectedRoleIds = new Set();

    document.addEventListener('DOMContentLoaded', function() {
      renderRoleTable();
      loadDepartmentOptions();
      loadSearchDepartmentOptions();
      setupDeptTagSync();
      renderPermissionTree();
    });

    function renderRoleTable() {
      const tbody = document.getElementById('roleTableBody');
      tbody.innerHTML = '';
      const flat = flattenDepartments(departmentData);
      const deptNameById = Object.fromEntries(flat.map(d => [d.id, d.name]));

      roleData.forEach((r, idx) => {
        const tr = document.createElement('tr');
        const deptNames = (r.departments || []).map(id => deptNameById[id]).filter(Boolean);
        tr.innerHTML = `
          <td class="check-col"><input type="checkbox" class="row-select" data-id="${r.id}" ${selectedRoleIds.has(r.id) ? 'checked' : ''}></td>
          <td>${r.name}</td>
          <td>${deptNames.length ? deptNames.join('、') : '-'}</td>
          <td>${r.remark || ''}</td>
          <td>${r.createTime || ''}</td>
          <td>
            <div class="op-btns">
              <button class="btn" onclick="showEditModal(${r.id})" title="编辑"><i class="fa-solid fa-edit"></i></button>
              <button class="btn" onclick="deleteRole(${r.id})" title="删除"><i class="fa-solid fa-trash"></i></button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // 绑定行选择事件
      Array.from(tbody.querySelectorAll('.row-select')).forEach(cb => {
        cb.addEventListener('change', function() {
          const id = parseInt(this.dataset.id);
          if (this.checked) {
            selectedRoleIds.add(id);
          } else {
            selectedRoleIds.delete(id);
          }
          updateSelectAllState();
        });
      });

      updateSelectAllState();
    }

    function loadDepartmentOptions() {
      const select = document.getElementById('roleDepartments');
      select.innerHTML = '';
      const flat = flattenDepartments(departmentData);
      flat.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = d.name;
        select.appendChild(opt);
      });
    }

    function loadSearchDepartmentOptions() {
      const select = document.getElementById('searchDepartment');
      if (!select) return;
      // 保留第一个“全部”选项
      const flat = flattenDepartments(departmentData);
      flat.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = d.name;
        select.appendChild(opt);
      });
    }

    function setupDeptTagSync() {
      const select = document.getElementById('roleDepartments');
      select.addEventListener('change', updateSelectedDeptTags);
    }

    function updateSelectedDeptTags() {
      const select = document.getElementById('roleDepartments');
      const container = document.getElementById('selectedDeptTags');
      container.innerHTML = '';
      Array.from(select.selectedOptions).forEach(opt => {
        const span = document.createElement('span');
        span.className = 'tag';
        span.textContent = opt.textContent;
        container.appendChild(span);
      });
    }

    function showAddModal() {
      currentEditRoleId = null;
      document.getElementById('modalTitle').textContent = '新增角色';
      document.getElementById('roleForm').reset();
      const select = document.getElementById('roleDepartments');
      if (select) select.selectedIndex = -1;
      updateSelectedDeptTags();
      renderPermissionTree();
      clearPermissionSelection();
      document.getElementById('roleModal').classList.add('show');
    }

    function showEditModal(id) {
      const r = roleData.find(x => x.id === id);
      if (!r) return;
      currentEditRoleId = id;
      document.getElementById('modalTitle').textContent = '编辑角色';
      document.getElementById('roleName').value = r.name || '';
      document.getElementById('roleDesc').value = r.remark || '';
      const select = document.getElementById('roleDepartments');
      Array.from(select.options).forEach(opt => {
        opt.selected = (r.departments || []).includes(parseInt(opt.value));
      });
      updateSelectedDeptTags();
      renderPermissionTree();
      setSelectedPermissions(r.permissions || []);
      document.getElementById('roleModal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('roleModal').classList.remove('show');
    }

    function saveRole() {
      const name = document.getElementById('roleName').value.trim();
      if (!name) { if (window.Message) Message.warning('请输入角色名称'); else alert('请输入角色名称'); return; }
      const remark = document.getElementById('roleDesc').value.trim();
      const select = document.getElementById('roleDepartments');
      const departments = Array.from(select.selectedOptions).map(opt => parseInt(opt.value));
      if (!departments.length) { if (window.Message) Message.warning('请选择所属部门'); else alert('请选择所属部门'); return; }
      const permissions = getSelectedPermissions();

      const now = new Date();
      const pad = (n) => String(n).padStart(2, '0');
      const createTimeStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;

      if (currentEditRoleId) {
        const r = roleData.find(x => x.id === currentEditRoleId);
        Object.assign(r, { name, remark, departments, permissions });
      } else {
        const newId = (Math.max(0, ...roleData.map(x => x.id)) + 1);
        roleData.push({ id: newId, name, remark, departments, permissions, createTime: createTimeStr });
      }
      closeModal();
      renderRoleTable();
    }

    function deleteRole(id) {
      showConfirm('确定删除该角色吗？删除后不可恢复！', () => {
        roleData = roleData.filter(x => x.id !== id);
        selectedRoleIds.delete(id);
        renderRoleTable();
      });
    }

    function showConfirm(message, onConfirm) {
      const overlay = document.getElementById('confirmOverlay');
      const msgEl = document.getElementById('confirmMessage');
      const okBtn = document.getElementById('confirmOkBtn');
      const cancelBtn = document.getElementById('confirmCancelBtn');
      msgEl.textContent = message;
      overlay.classList.add('show');
      const cleanup = () => { overlay.classList.remove('show'); okBtn.onclick = null; cancelBtn.onclick = null; };
      cancelBtn.onclick = cleanup;
      okBtn.onclick = () => { cleanup(); try { onConfirm && onConfirm(); } catch (e) { console.error(e); } };
    }

    function searchRoles() {
      const key = document.getElementById('searchRoleName').value.trim();
      const deptVal = document.getElementById('searchDepartment') ? document.getElementById('searchDepartment').value : '';
      const deptId = deptVal ? parseInt(deptVal) : null;
      const tbody = document.getElementById('roleTableBody');
      if (!key && !deptId) { renderRoleTable(); return; }
      const flat = flattenDepartments(departmentData);
      const deptNameById = Object.fromEntries(flat.map(d => [d.id, d.name]));
      const filtered = roleData.filter(r => {
        const matchName = !key || (r.name||'').includes(key);
        const matchDept = !deptId || (r.departments||[]).includes(deptId);
        return matchName && matchDept;
      });
      tbody.innerHTML = '';
      filtered.forEach((r, idx) => {
        const tr = document.createElement('tr');
        const deptNames = (r.departments || []).map(id => deptNameById[id]).filter(Boolean);
        tr.innerHTML = `
          <td class="check-col"><input type="checkbox" class="row-select" data-id="${r.id}" ${selectedRoleIds.has(r.id) ? 'checked' : ''}></td>
          <td>${r.name}</td>
          <td>${deptNames.length ? deptNames.join('、') : '-'}</td>
          <td>${r.remark || ''}</td>
          <td>${r.createTime || ''}</td>
          <td>
            <div class="op-btns">
              <button class="btn" onclick="showEditModal(${r.id})" title="编辑"><i class="fa-solid fa-edit"></i></button>
              <button class="btn" onclick="deleteRole(${r.id})" title="删除"><i class="fa-solid fa-trash"></i></button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      Array.from(tbody.querySelectorAll('.row-select')).forEach(cb => {
        cb.addEventListener('change', function() {
          const id = parseInt(this.dataset.id);
          if (this.checked) {
            selectedRoleIds.add(id);
          } else {
            selectedRoleIds.delete(id);
          }
          updateSelectAllState();
        });
      });

      updateSelectAllState();
    }

    function resetSearch() {
      document.getElementById('searchRoleName').value = '';
      const deptSelect = document.getElementById('searchDepartment');
      if (deptSelect) deptSelect.value = '';
      renderRoleTable();
    }

    function logout() {
      if (confirm('确定要退出登录吗？')) {
        window.location.href = 'login.html';
      }
    }

    // 新增：更新全选复选框状态 & 绑定全选事件
    function updateSelectAllState() {
      const allCb = document.getElementById('selectAllRoles');
      const checkboxes = document.querySelectorAll('#roleTableBody .row-select');
      const total = checkboxes.length;
      const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
      if (!allCb) return;
      allCb.indeterminate = (checked > 0 && checked < total);
      allCb.checked = (total > 0 && checked === total);
    }

    // 批量删除选中角色
    function deleteSelectedRoles() {
      if (!selectedRoleIds.size) {
        if (window.Message) Message.warning('请选择需要删除的数据！');
        else alert('请选择需要删除的数据！');
        return;
      }
      showConfirm('确定删除选中的角色吗？删除后不可恢复！', () => {
        roleData = roleData.filter(r => !selectedRoleIds.has(r.id));
        selectedRoleIds.clear();
        renderRoleTable();
      });
    }
  </script>
</body>
</html>