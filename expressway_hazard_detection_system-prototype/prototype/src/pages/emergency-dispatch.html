<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>应急指挥 · 资源绑定</title>
  <link rel="icon" href="../assets/logo-hrecs-radar.svg" type="image/svg+xml">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="../css/styles.css">
  <script src="../components/app-layout.js"></script>
  <style>
    :root { --blue-6:#2F54EB; --border:#e5e7eb; --muted:#6b7280;}
    body { margin:0; background:#f6f8fc; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans','PingFang SC','Microsoft YaHei',sans-serif; }
    .layout { display:grid; grid-template-columns: 360px 1fr; gap:16px; height:100%; }
    .panel { background:#fff; border:1px solid var(--border); border-radius:10px; padding:12px; display:flex; flex-direction:column; }
    .panel-header { font-weight:600; color:#1f2937; margin-bottom:8px; }
    .list { display:flex; flex-direction:column; gap:8px; }
    .item { border:1px solid #f0f0f0; border-radius:8px; padding:8px; }
    .muted { color:var(--muted); font-size:12px; }
    .toolbar { display:flex; gap:8px; margin-bottom:8px; }
    .bind-form { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:8px; }
    .bind-checked { grid-column: 1 / -1; }
    .focus { background:#fff9e6; border-color:#ffe58f; }
    /* 弹窗样式 */
    .modal-overlay { position: fixed; inset:0; background: rgba(0, 0, 0, 0.45); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-overlay.show { display: flex; }
    .modal { background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); width: 560px; max-width: 90vw; overflow: hidden; }
    .modal-header { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; display:flex; align-items:center; justify-content:space-between; }
    .modal-close { width:28px; height:28px; border-radius:50%; border:0; background:transparent; color:#666; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .modal-close:hover { background:#f5f5f5; }
    .modal-close:active { background:#eee; }
    .modal-body { padding: 16px; }
    .modal-actions { padding: 12px 16px; border-top: 1px solid #f0f0f0; display:flex; justify-content:flex-end; gap:10px; }
    .form-row { display:flex; gap:8px; margin-bottom:8px; }
    .form-col { flex:1; display:flex; flex-direction:column; gap:6px; }
    .chips { display:flex; flex-direction:column; gap:6px; }
    .res-chip { display:flex; align-items:center; gap:8px; border:1px solid #f0f0f0; border-radius:20px; padding:6px 10px; }
    .chip-actions { display:flex; gap:6px; margin-left:auto; }
    .chip-edit { display:none; margin-top:6px; gap:6px; }
    .seg { display:flex; gap:6px; }
    .panel-subheader {color:#374151; margin:8px 0 4px; }
    .list-toolbar { display:flex; gap:6px; margin-bottom:6px; }
    /* TreeSelect 样式 */
    .tree-select { flex:1;position: relative; }
    .tree-select-control { display:flex; align-items:center; gap:8px; border:1px solid #f0f0f0; border-radius:6px; padding:6px 8px; cursor:pointer; min-height:40px; background:#fff; }
    .tree-select-control i { color:#888; margin-left:auto; }
    .tree-select-dropdown { position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #f0f0f0; border-radius:8px; box-shadow: 0 8px 16px rgba(0,0,0,0.08); padding:8px; margin-top:4px; display:none; z-index:1000; }
    .tree-select.open .tree-select-dropdown { display:block; }
    .chips-inline { display:flex; flex-wrap:wrap; gap:6px; flex:1; }
    /* Tabs (Ant Design-like) */
    .tabs-bar { display:flex; gap:16px; border-bottom:1px solid #f0f0f0; margin-bottom:8px; }
    .tab-item { padding:8px 12px; cursor:pointer; color:#4b5563; }
    .tab-item.active { color: var(--blue-6); border-bottom: 2px solid var(--blue-6); font-weight:600; }
    /* 右侧面板：仅“确认绑定”单列显示 */
    .right-cols { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media (max-width: 1024px){ .layout { grid-template-columns: 1fr; } .right-cols { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <app-layout active="emergency-dispatch" breadcrumb="首页 / 应急指挥 / 资源绑定">
    <div slot="content" class="content-body" style="gap:16px;">
      <div class="layout">
        <div class="panel">
          <div class="panel-header">选择事件</div>
          <div class="toolbar">
            <select id="incidentSelect" class="select" style="flex:1;"></select>
          </div>
          <div class="panel-header">资源池</div>
          <div id="resourceList" class="list"></div>
        </div>
        <div class="right-cols">
          <div class="panel">
            <div class="panel-header">确认绑定</div>
            <div class="bind-form">
              <div class="bind-checked">
                <label>已勾选资源</label>
                <div id="checkedSummary" class="muted">尚未勾选</div>
                <div id="checkedChips" class="chips" style="margin-top:6px;"></div>
              </div>
              <div style="grid-column: 1 / -1;display: flex; flex-direction:column; gap:6px;">
                <div class="panel-subheader">接收人 <span style="color:#ff4d4f; font-weight:600;">*</span> <span class="muted">（必填）</span></div>
                <div id="recipientTreeSelect" class="tree-select">
                  <div class="tree-select-control" onclick="toggleRecipientDropdown()">
                    <div id="recipientChips" class="chips-inline"></div>
                    <div id="recipientSummary" class="muted">尚未选择</div>
                    <i class="fa-solid fa-chevron-down"></i>
                  </div>
                  <div id="recipientDropdown" class="tree-select-dropdown">
                    <div class="list-toolbar">
                      <input id="recipientTreeSearch" class="input" placeholder="搜索姓名/角色/部门" style="flex:1;" />
                      <button id="recipientToggleAll" class="btn" onclick="toggleSelectAllRecipients()"><i class='fa-solid fa-square-check'></i> 全选当前结果</button>
                    </div>
                    <div id="recipientTree" class="list"></div>
                  </div>
                </div>
                <div id="recipientError" class="muted" style="color:#ff4d4f; display:none;">请至少选择一名接收人</div>
              </div>
              <div>
                <label>出发地</label>
                <input id="bindFrom" class="input" placeholder="如：站点X" />
              </div>
              <div>
                <label>目的地</label>
                <input id="bindTo" class="input" placeholder="如：隧道A入口" />
              </div>
              <div style="grid-column: 1 / -1;">
                <label>备注</label>
                <input id="bindNote" class="input" placeholder="可选" />
              </div>
            </div>
            <div class="toolbar" style="justify-content:flex-end;">
              <button id="openBindReviewBtn" class="btn btn-primary" onclick="openBindReview()"><i class="fa-solid fa-list-check"></i> 复核并绑定</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </app-layout>

  <!-- 复核弹窗 -->
  <div id="reviewModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header"><div>复核绑定清单</div><button class="modal-close" onclick="closeBindReview()" title="关闭"><i class="fa-solid fa-xmark"></i></button></div>
      <div class="modal-body">
        <div id="reviewList" class="list"></div>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeBindReview()">返回调整</button>
        <button class="btn btn-primary" onclick="confirmBind()"><i class="fa-solid fa-check"></i> 确认绑定</button>
      </div>
    </div>
  </div>

  <script>
    const storeKey = 'incidentStore';
    function loadStore(){ try{ return JSON.parse(localStorage.getItem(storeKey)||'{}'); }catch(e){ return {}; } }
    function saveStore(data){ localStorage.setItem(storeKey, JSON.stringify(data)); }
    function seed(){ const s=loadStore(); if(s.incidents&&s.incidents.length) return; const incidents=[
      { id:'INC-20251102-001', type:'隧道火灾', level:'II级', location:'隧道A-出口', createdAt:'2025-11-02 08:33', status:'open', timeline:[{at:'2025-11-02 08:33', type:'created', text:'事件创建'}], resources:[] },
      { id:'INC-20251102-002', type:'路面塌陷', level:'III级', location:'路段C-中段', createdAt:'2025-11-02 09:55', status:'open', timeline:[{at:'2025-11-02 09:55', type:'created', text:'事件创建'}], resources:[] }
    ]; saveStore({ incidents }); }
    seed();

    // 部门-角色-人员 数据（示例）
    const org = [
      { id:'dept_maint', name:'养护部门', roles:[
        { id:'role_leader', name:'现场负责人', persons:[{id:'U-101', name:'王强'},{id:'U-102', name:'刘敏'}] },
        { id:'role_team', name:'救援队A', persons:[{id:'U-111', name:'李林'},{id:'U-112', name:'赵凯'}] }
      ]},
      { id:'dept_police', name:'交警部门', roles:[
        { id:'role_traffic', name:'交通分流组', persons:[{id:'U-201', name:'陈峰'},{id:'U-202', name:'周杰'}] }
      ]}
    ];
    // 其他资源（设备/物资）保留（可选绑定）
    const resources = [
      { id:'V-201', type:'material', name:'消防车-一号' },
      { id:'M-501', type:'material', name:'隔离锥 200个' }
    ];

    const state = { incidentId: null, qMaterial: '', qRecipient: '', deptOpen: {}, roleOpen: {} };
    const overrides = {}; // 每项的备注与路线覆盖 { [id]: { note, from, to } }
    function getIncidents(){ return loadStore().incidents||[]; }
    function setIncidents(list){ const s=loadStore(); s.incidents=list; saveStore(s); }
    function currentIncident(){ return getIncidents().find(i=>i.id===state.incidentId)||null; }

    function initIncidentSelect(){ const sel=document.getElementById('incidentSelect'); sel.innerHTML=''; getIncidents().forEach(i=>{ const opt=document.createElement('option'); opt.value=i.id; opt.textContent=`${i.id} · ${i.type} · ${i.location}`; sel.appendChild(opt); });
      const hash=location.hash.startsWith('#')?location.hash.slice(1):location.hash; const p=new URLSearchParams(hash); const fromHash=p.get('incidentId'); sel.value = fromHash || getIncidents()[0]?.id || '';
      state.incidentId=sel.value; sel.addEventListener('change', ()=>{ state.incidentId=sel.value; renderCheckedSummary(); });
    }

    function renderResources(){ const wrap=document.getElementById('resourceList'); wrap.innerHTML='';
      const qMat = (state.qMaterial||'').trim().toLowerCase(); const matchesMaterial = (text) => (!qMat || String(text).toLowerCase().includes(qMat));
      // 仅物资列表块（设备统一归为物资）
      const materialList=document.createElement('div'); materialList.className='list'; materialList.id='materialList';
      const materialToolbar=document.createElement('div'); materialToolbar.className='list-toolbar';
      materialToolbar.innerHTML = `
        <input id='searchMaterial' class='input' placeholder='搜索资源名/编号' style='flex:1;' />
        <button id='materialToggleAll' class='btn' onclick="toggleSelectAllType('material')"><i class='fa-solid fa-square-check'></i> 全选当前结果</button>
      `;
      materialList.appendChild(materialToolbar);
      const matSearchEl = materialToolbar.querySelector('#searchMaterial');
      if(matSearchEl){ matSearchEl.value = state.qMaterial; matSearchEl.addEventListener('input', (e)=>{ state.qMaterial = e.target.value; renderResources(); }); }
      resources.filter(r=>matchesMaterial(r.name)||matchesMaterial(r.id)).forEach(r=>{
        const div=document.createElement('div'); div.className='item'; div.innerHTML=`<label style='display:flex;align-items:center;gap:8px;'>
          <input type='checkbox' class='res-check' data-id='${r.id}' data-type='material' data-name='${r.name}'>
          <strong>${r.name}</strong> · <span class='muted'>${r.id}</span>
          <span class='muted' style='margin-left:auto;'>类型：物资</span></label>`;
        div.querySelector('.res-check').addEventListener('change', renderCheckedSummary); materialList.appendChild(div);
      });
      wrap.appendChild(materialList);
      renderCheckedSummary();
    }

    function allRoles(){ return org.flatMap(d => d.roles || []); }
    function roleById(id){ return allRoles().find(r => r.id === id); }
    // 角色选择与资源下拉已移除，改为在资源池中勾选

    function updateBindOptions(){ /* no-op: 改为勾选资源池实现选择（仅物资） */ }

    function collectSelected(){
      return Array.from(document.querySelectorAll('.res-check:checked')).map(el => ({
        id: el.dataset.id,
        type: el.dataset.type,
        name: el.dataset.name,
        role: el.dataset.role,
        dept: el.dataset.dept
      }));
    }

    function renderCheckedSummary(){
      const selected = collectSelected();
      const sum = document.getElementById('checkedSummary');
      if (sum) sum.textContent = selected.length ? `${selected.length} 项：${selected.map(s=>s.name).join('、')}` : '尚未勾选';
      const chips = document.getElementById('checkedChips'); if (!chips) return; chips.innerHTML='';
      selected.forEach(s => {
        const chip = document.createElement('div'); chip.className='res-chip';
        chip.innerHTML = `<span>${s.name}</span><span class='muted'>${s.type}${s.role?` · ${s.role}`:''}</span>
          <div class='chip-actions'>
            <button class='btn' onclick="removeSelected('${s.id}')"><i class='fa-solid fa-xmark'></i> 移除</button>
          </div>`;
        chips.appendChild(chip);
      });
      refreshListToolbar();
    }
    function setOverride(id, key, val){ (overrides[id] = overrides[id] || {})[key] = val; }
    function removeSelected(id){ const el = Array.from(document.querySelectorAll('.res-check')).find(e=>e.dataset.id===id); if (el) { el.checked=false; } renderCheckedSummary(); }
    function setActiveTab(t){ state.activeTab=t; const p=document.getElementById('tabPerson'); const m=document.getElementById('tabMaterial'); if (p&&m){ if(t==='person'){ p.classList.add('active'); m.classList.remove('active'); } else { m.classList.add('active'); p.classList.remove('active'); } } renderResources(); refreshListToolbar(); }
    // 顶部搜索框已拆分到各自 Tab 内容的工具条中
    function isAllSelected(listId){ const list=document.getElementById(listId); if(!list) return false; const checks=list.querySelectorAll('.res-check'); if(checks.length===0) return false; return Array.from(checks).every(el=>el.checked); }
    function toggleSelectAllType(type){ const listId = type==='person' ? 'peopleList' : 'materialList'; const list=document.getElementById(listId); if(!list) return; const all=isAllSelected(listId); list.querySelectorAll('.res-check').forEach(el=>{ el.checked = !all; }); renderCheckedSummary(); refreshListToolbar(); }
    function refreshListToolbar(){
      const pplBtn=document.getElementById('peopleToggleAll');
      if(pplBtn){ const all=isAllSelected('peopleList');
        pplBtn.innerHTML = all ? "<i class='fa-solid fa-xmark'></i> 取消全选" : "<i class='fa-solid fa-square-check'></i> 全选当前结果";
      }
      const matBtn=document.getElementById('materialToggleAll');
      if(matBtn){ const all=isAllSelected('materialList');
        matBtn.innerHTML = all ? "<i class='fa-solid fa-xmark'></i> 取消全选" : "<i class='fa-solid fa-square-check'></i> 全选当前结果";
      }
    }

    function findPersonById(id){ for(const d of org){ for(const r of (d.roles||[])){ const p=(r.persons||[]).find(x=>x.id===id); if(p) return { id:p.id, type:'person', name:p.name }; } } return null; }

    // 已绑定资源面板移除，UI以“已勾选资源”摘要展示当前选择

    function highlightRecipientError(hasError, openOnError){ const root=document.getElementById('recipientTreeSelect'); const ctrl=root?root.querySelector('.tree-select-control'):null; const err=document.getElementById('recipientError');
      if(ctrl){ ctrl.classList.toggle('focus', !!hasError); }
      if(err){ err.style.display = hasError ? 'block' : 'none'; }
      if(hasError && openOnError){ const root=document.getElementById('recipientTreeSelect'); if(root && !root.classList.contains('open')) root.classList.add('open'); }
    }
    function validateRecipients(openOnError=false){ const recipients = collectRecipients(); const ok = recipients.length>0; highlightRecipientError(!ok, openOnError); return ok; }
    function updateBindCtaState(){ const btn=document.getElementById('openBindReviewBtn'); if(btn){ btn.disabled = !validateRecipients(); } }
    function openBindReview(){ const selected = collectSelected(); if (!selected.length) { alert('请在左侧资源池勾选至少一项'); return; }
      if(!validateRecipients(true)){ return; }
      const list = document.getElementById('reviewList'); list.innerHTML='';
      const note = document.getElementById('bindNote').value.trim(); const from=document.getElementById('bindFrom').value.trim(); const to=document.getElementById('bindTo').value.trim();
      const recipients = collectRecipients();
      // 顶部显示接收人摘要
      const recap = document.createElement('div'); recap.className='item';
      recap.innerHTML = `<div><strong>接收人</strong></div><div class='muted'>${recipients.length? recipients.map(p=>p.name).join('、') : '无'}</div>`;
      list.appendChild(recap);
      selected.forEach(s => {
        const ov = overrides[s.id]||{}; const n = ov.note ?? note; const f = ov.from ?? from; const t = ov.to ?? to;
        const div = document.createElement('div'); div.className='item';
        div.innerHTML = `<div style='display:flex;align-items:center;justify-content:space-between;gap:8px;'><strong>${s.name}</strong><span class='muted'>${s.type}${s.role?` · ${s.role}`:''}</span></div>
          <div class='muted'>备注：${n||'-'} · 路线：${(f||'-')} → ${(t||'-')}</div>`;
        list.appendChild(div);
      });
      document.getElementById('reviewModal').classList.add('show');
    }
    function closeBindReview(){ document.getElementById('reviewModal').classList.remove('show'); }
    function confirmBind(){ const i=currentIncident(); if(!i) return; const selected = collectSelected().filter(s=>s.type!=='person'); if (!selected.length) { closeBindReview(); return; }
      if(!validateRecipients(true)){ return; }
      const note = document.getElementById('bindNote').value.trim(); const from=document.getElementById('bindFrom').value.trim(); const to=document.getElementById('bindTo').value.trim();
      const recipients = collectRecipients();
      updateIncident(i2=>{
        const when = new Date().toISOString().replace('T',' ').slice(0,16);
        i2.resources = i2.resources || [];
        i2.timeline = i2.timeline || [];
        selected.forEach(s => {
          const ov = overrides[s.id]||{}; const n = ov.note ?? note; const f = ov.from ?? from; const t = ov.to ?? to;
          const route = (f||t) ? { from:f||'', to:t||'' } : null;
          const entity = resources.find(x=>x.id===s.id) || { id:s.id, type:s.type, name:s.name };
          const bound = { resourceId: entity.id, type: entity.type, name: entity.name, boundAt: when, note:n, route };
          if (!i2.resources.some(x=>x.resourceId===bound.resourceId)) i2.resources.push(bound);
          i2.timeline.push({ at: when, type:'resource_bound', text:`绑定资源 ${entity.name}`, route, recipients: recipients.map(p=>({ id:p.id, name:p.name })) });
        });
        // 可选：在事件级别记录最后一次选择的接收人集合
        i2.recipients = recipients.map(p=>({ id:p.id, name:p.name }));
      });
      // 清理状态
      closeBindReview();
      document.querySelectorAll('.res-check:checked').forEach(el => { el.checked=false; });
      Object.keys(overrides).forEach(k => delete overrides[k]);
      renderCheckedSummary();
    }

    function unbindResource(resourceId){ updateIncident(i=>{ i.resources=i.resources.filter(x=>x.resourceId!==resourceId); i.timeline.push({ at:new Date().toISOString().replace('T',' ').slice(0,16), type:'resource_unbound', text:`解绑资源 ${resourceId}` }); }); }

    function editBoundResource(resourceId){ const i=currentIncident(); if(!i) return; const r=i.resources.find(x=>x.resourceId===resourceId); if(!r) return; const note=prompt('更新备注', r.note||'')||''; const from=prompt('更新出发地', (r.route&&r.route.from)||'')||''; const to=prompt('更新目的地', (r.route&&r.route.to)||'')||'';
      updateIncident(i2=>{ const rr=i2.resources.find(x=>x.resourceId===resourceId); if(!rr) return; rr.note=note; rr.route=(from||to)?{from,to}:null; i2.timeline.push({ at:new Date().toISOString().replace('T',' ').slice(0,16), type:'resource_update', text:`更新资源 ${rr.name}`, route: rr.route }); }); }

    // 到场统一在事件中心页面操作，此处不提供签到功能

    function updateIncident(mutator){ const list=getIncidents(); const idx=list.findIndex(x=>x.id===state.incidentId); if(idx<0) return; mutator(list[idx]); setIncidents(list); renderCheckedSummary(); }

    // 初始化
    initIncidentSelect();
    renderResources();
    // 接收人渲染与事件绑定
    function collectRecipients(){
      // 支持旧类名与新TreeSelect类名，向后兼容
      const checks = document.querySelectorAll('.recipient-tree-check:checked, .recipient-check:checked');
      return Array.from(checks).map(el => ({
        id: el.dataset.id,
        type: 'person',
        name: el.dataset.name,
        role: el.dataset.role,
        dept: el.dataset.dept
      }));
    }
    function isAllSelectedRecipients(){ const list=document.getElementById('recipientTree'); if(!list) return false; const checks=list.querySelectorAll('.recipient-tree-check'); if(checks.length===0) return false; return Array.from(checks).every(el=>el.checked); }
    function toggleSelectAllRecipients(){ const list=document.getElementById('recipientTree'); if(!list) return; const all=isAllSelectedRecipients(); list.querySelectorAll('.recipient-tree-check').forEach(el=>{ el.checked = !all; }); renderRecipientSummary(); }
    function removeRecipientSelected(id){ const el = Array.from(document.querySelectorAll('.recipient-tree-check, .recipient-check')).find(e=>e.dataset.id===id); if (el) { el.checked=false; } renderRecipientSummary(); }
    function renderRecipientSummary(){ const selected = collectRecipients(); const sum = document.getElementById('recipientSummary'); if (sum) sum.textContent = selected.length ? `${selected.length} 人：${selected.map(s=>s.name).join('、')}` : '尚未选择';
      const chips = document.getElementById('recipientChips'); if (!chips) return; chips.innerHTML='';
      selected.forEach(s => { const chip=document.createElement('div'); chip.className='res-chip'; chip.innerHTML=`<span>${s.name}</span><span class='muted'>${s.role?`角色：${s.role}`:''}${s.dept?` · ${s.dept}`:''}</span>
        <div class='chip-actions'><button class='btn' onclick="removeRecipientSelected('${s.id}')"><i class='fa-solid fa-xmark'></i> 移除</button></div>`; chips.appendChild(chip); });
      highlightRecipientError(selected.length===0, false);
      updateBindCtaState();
    }
    function toggleDept(id){ state.deptOpen[id] = !state.deptOpen[id]; renderRecipients(); }
    function toggleRole(id){ state.roleOpen[id] = !state.roleOpen[id]; renderRecipients(); }
    // TreeSelect 开关与外部点击关闭
    function toggleRecipientDropdown(){ const root=document.getElementById('recipientTreeSelect'); if(root){ root.classList.toggle('open'); } }
    function closeRecipientDropdown(){ const root=document.getElementById('recipientTreeSelect'); if(root){ root.classList.remove('open'); } }
    document.addEventListener('click', (e)=>{ const root=document.getElementById('recipientTreeSelect'); if(!root) return; if(root.contains(e.target)) return; closeRecipientDropdown(); });
    function checkPersonsByIds(ids, checked){ ids.forEach(id=>{ const el=document.querySelector(`.recipient-tree-check[data-id='${id}']`); if(el) el.checked=checked; }); renderRecipientSummary(); }
    function onDeptCheck(deptId, checked){ const dept = org.find(d=>d.id===deptId); if(!dept) return; const ids = dept.roles.flatMap(r => (r.persons||[]).map(p=>p.id)); checkPersonsByIds(ids, checked); }
    function onRoleCheck(roleId, checked){ let role=null; let ids=[]; org.forEach(d=>{ (d.roles||[]).forEach(r=>{ if(r.id===roleId){ role=r; ids=(r.persons||[]).map(p=>p.id); } }); }); if(!role) return; checkPersonsByIds(ids, checked); }
    function renderRecipients(){ const list=document.getElementById('recipientTree'); if(!list) return; list.innerHTML='';
      const q=(state.qRecipient||'').trim().toLowerCase(); const matches=(text)=>(!q || String(text).toLowerCase().includes(q));
      org.forEach(d=>{ const deptBox=document.createElement('div'); deptBox.className='item';
        const isOpen = state.deptOpen[d.id] !== false; // 默认展开
        deptBox.innerHTML = `<div style='display:flex;align-items:center;gap:8px;'>
            <i class="fa-solid ${isOpen?'fa-chevron-down':'fa-chevron-right'}" style='cursor:pointer;' onclick="toggleDept('${d.id}')"></i>
            <strong style='cursor:pointer;' onclick="toggleDept('${d.id}')">${d.name}</strong>
            <div style='margin-left:auto; display:flex; align-items:center; gap:6px;'>
              <label class='muted' style='display:flex; align-items:center; gap:6px;'>
                <input type='checkbox' class='recipient-dept-check' data-id='${d.id}' onchange="onDeptCheck('${d.id}', this.checked)">
                <span>全选部门</span>
              </label>
            </div>
          </div>`;
        const deptContent=document.createElement('div'); deptContent.style.margin='6px 0 0 18px'; deptContent.style.display = isOpen ? 'block' : 'none';
        let deptHasRows=false;
        d.roles.forEach(r=>{
          const persons=(r.persons||[]).filter(p=>matches(p.name)||matches(r.name)||matches(d.name));
          if(persons.length===0) return;
          const roleBox=document.createElement('div');
          const roleOpen = state.roleOpen[r.id] !== false; // 默认展开
          roleBox.innerHTML = `<div class='muted' style='margin:4px 0; display:flex; align-items:center; gap:8px;'>
              <i class="fa-solid ${roleOpen?'fa-chevron-down':'fa-chevron-right'}" style='cursor:pointer;' onclick="toggleRole('${r.id}')"></i>
              <span style='cursor:pointer;' onclick="toggleRole('${r.id}')">角色：${r.name}</span>
              <div style='margin-left:auto; display:flex; align-items:center; gap:6px;'>
                <label class='muted' style='display:flex; align-items:center; gap:6px;'>
                  <input type='checkbox' class='recipient-role-check' data-id='${r.id}' onchange="onRoleCheck('${r.id}', this.checked)">
                  <span>全选角色</span>
                </label>
              </div>
            </div>`;
          const roleContent=document.createElement('div'); roleContent.style.margin='4px 0 0 18px'; roleContent.style.display = roleOpen ? 'block' : 'none';
          persons.forEach(p=>{ const line=document.createElement('div'); line.innerHTML=`<label style='display:flex;align-items:center;gap:8px;'>
                <input type='checkbox' class='recipient-tree-check' data-id='${p.id}' data-name='${p.name}' data-role='${r.name}' data-dept='${d.name}'>
                <span>${p.name}</span><span class='muted' style='margin-left:auto;'>人员</span></label>`;
            line.querySelector('.recipient-tree-check').addEventListener('change', renderRecipientSummary); roleContent.appendChild(line); deptHasRows=true; });
          roleBox.appendChild(roleContent); deptContent.appendChild(roleBox);
        });
        if(deptHasRows){ deptBox.appendChild(deptContent); list.appendChild(deptBox); }
      });
      // 绑定搜索输入事件
      const qEl=document.getElementById('recipientTreeSearch'); if(qEl){ qEl.value=state.qRecipient; qEl.addEventListener('input',(e)=>{ state.qRecipient=e.target.value; renderRecipients(); }); }
      renderRecipientSummary();
    }
    renderRecipients();
    updateBindCtaState();
  </script>
</body>
</html>